---
title: "PyO3 + Poetryã§Pythonã‹ã‚‰Rustå®Ÿè£…ã‚’ä½¿ã†"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "python"]
published: true
---

# ã¯ã˜ã‚ã«

Rustã§ä½œã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãã«ã¯[PyO3](https://github.com/PyO3/pyo3)ãŒä¾¿åˆ©ã§ã‚ã‚‹ã€‚ã“ã‚Œã‚’ç”¨ã„ã‚‹ã¨ç°¡å˜ã«Rustå®Ÿè£…ã‚’Pythonã‹ã‚‰åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã®ã‚ˆã†ãªRustå®Ÿè£…ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã¯Wheelå½¢å¼ã§å„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ï¼ˆx86_64å‘ã‘ãªã©ï¼‰ã”ã¨ã«ãƒã‚¤ãƒŠãƒªå½¢å¼ã§é…å¸ƒã™ã‚‹ã¨ã€åˆ©ç”¨è€…ãŒRustç’°å¢ƒã‚’æ§‹ç¯‰ã—ãªãã¦ã‚‚ã‚ˆããªã£ã¦ä¾¿åˆ©ã§ã‚ã‚‹ã€‚ã“ã®è¨˜äº‹ã§ã¯PyO3ã®ç°¡å˜ãªä½¿ã„æ–¹ã‚’è§£èª¬ã—ã€PyO3ãŒé…å¸ƒã—ã¦ã„ã‚‹[Maturin](https://github.com/PyO3/maturin)ã‚’[Poetry](https://python-poetry.org/)ã‹ã‚‰åˆ©ç”¨ã—ã¦Pythonã‹ã‚‰Rustå®Ÿè£…ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã‚Šã€Wheelä½œæˆã™ã‚‹æ–¹æ³•ã‚’è¿°ã¹ã‚‹ã€‚
ã“ã®è¨˜äº‹ã§åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®GitHubãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã€‚

- https://github.com/y-yu/pytomlrs

# ã¤ãã£ãŸã‚‚ã®

ä¸‹è¨˜ã®ã‚ˆã†ã«Pythonã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©ã—ã€`pytomlrs.to_toml`ã§TOMLã¸ã¨å¤‰æ›ã§ãã‚‹ã€‚

```python
import pytomlrs

python_value = {
    'a': {
        'b': 1,
        'c': True
    },
    'd': {
        'e': [1.2, 'foobar']
    }
}
print(pytomlrs.to_toml(python_value))
```

```toml
[a]
b = 1
c = true

[d]
e = [1.2, "foobar"]
```

ä¸­èº«ã¯[hyperjson](https://github.com/mre/hyperjson)ã‚’[toml](https://github.com/toml-rs/toml)ç‰ˆã¨ãªã£ã¦ã„ã‚‹ã€‚

# Rustã«ã‚ˆã‚‹å®Ÿè£…

## `Cargo.toml`

ã¾ãš`Cargo.toml`ã«ä»Šå›ç”¨ã„ã‚‹`pyo3`ã®ä¾å­˜ã‚’è¿½åŠ ã™ã‚‹ã€‚

```toml:Cargo.toml
[package]
name = "pytomlrs"
version = "0.1.0"
edition = "2021"

[dependencies]
pyo3 = { version = "0.19.*", features = [ "extension-module" ] }
serde = "1.0.*"
toml = { version = "0.7.6", features = [ "parse" ] }
```

## ãƒ¡ã‚½ãƒƒãƒ‰ä½œæˆ

æ¬¡ã«Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…ã‚’ä½œã£ã¦ã„ã[^cut_impl]ã€‚

[^cut_impl]: ä»Šå›ã®è¨˜äº‹ã¯TOMLå¤‰æ›ã®å®Ÿè£…ã‚’è§£èª¬ã™ã‚‹ã¨ã„ã†ã‚ˆã‚Šã¯ã€Pythonã‹ã‚‰ã®ä½¿ã„æ–¹ã‚’è§£èª¬ã™ã‚‹ã®ã§`to_toml`/`from_toml`ã®å®Ÿè£…è©³ç´°ã¯çœç•¥ã™ã‚‹ã€‚ã“ã‚Œã‚‰ã®å®Ÿè£…ãŒæ°—ã«ãªã‚‹å ´åˆã¯GitHubãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã‚’å‚è€ƒã«ã—ã¦ã»ã—ã„ã€‚

```rust:src/lib.rs
#[pyfunction]
pub fn to_toml(py: Python, obj: PyObject) -> PyResult<PyObject> {
    /* å®Ÿè£… */
}

#[pyfunction]
pub fn from_toml(py: Python, obj: PyObject) -> PyResult<PyObject> {
    /* å®Ÿè£… */
}

#[pymodule]
fn pytomlrs<'py>(_py: Python<'py>, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(to_toml, m)?)?;
    m.add_function(wrap_pyfunction!(from_toml, m)?)?;
    Ok(())
}
```

ã“ã‚Œã§Rustå´ã®æº–å‚™ã¯çµ‚äº†ã¨ãªã‚‹ã€‚

# Pythonã‹ã‚‰ã®å‘¼ã³å‡ºã—

## `pyproject.toml`ã®è¨­å®š

ä»Šå›ã®è¨˜äº‹ã§ã¯Poetryã®åˆ©ç”¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹ãŸã‚ã€Poetryã‹ã‚‰Rustè£½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«è¡Œã£ã¦ãŠãã€‚

```toml:pyproject.toml
[tool.poetry]
name = "pytomlrs"
version = "0.1.0"
description = ""
authors = [ "YOSHIMURA Yuu <yyu@mental.poker>" ]

[tool.poetry.dependencies]
python = ">=3.9,<4.0"

[tool.poetry.dev-dependencies]
wheel = "*"
pytest = "^7.4"
maturin = "==1.2.0"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"
```

åŸºæœ¬çš„ã«ã¯`maturin`ã®ä¾å­˜ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã‚ã‚‹ã€‚

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã«`__init__.py`ã‚’è¨­å®š

ã“ã‚ŒãŒã©ã†ã—ã¦å¿…è¦ã«ãªã‚‹ã®ã‹ã‚ˆãç†è§£ã§ãã¦ã¯ã„ãªã„ãŒã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼æ§‹æˆã§`pytomlrs/__init__.py`ã®ã‚ˆã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã®ä¸­ã«`__init__.py`ã‚’è¨­ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```
.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ poetry.lock
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ pytomlrs
â”‚Â Â  â””â”€â”€ __init__.py
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ lib.rs
â”‚Â Â  â””â”€â”€ serde_pyobject.rs
â””â”€â”€ tests
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_pytomlrs.py
```

`pytomlrs/__init__.py`ã¯æ¬¡ã®ã‚ˆã†ãªå†…å®¹ã«ãªã‚‹ã€‚

```python:pytomlrs/__init__.py
from .pytomlrs import *
```

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã“ã“ã¾ã§ã§Rustè£½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’pipã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æº–å‚™ãŒã§ããŸã®ã§ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Poetryé…ä¸‹ã®pipã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```console
$ poetry run maturin develop
```

## ãƒ†ã‚¹ãƒˆ

è¨­å®šã¾ã‚ã‚ŠãŒã§ããŸã¨ã“ã‚ã§ã€Pythonã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦å®Ÿè¡Œã™ã‚‹ã€‚ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’ç”¨æ„ã—ã¦ã€å®Ÿéš›ã«TOMLå¤‰æ›ãŒä¸Šæ‰‹ãã„ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚

```python
import pytomlrs

python_value = {
    'a': {
        'b': 1,
        'c': True
    },
    'd': {
        'e': [1.2, 'foobar']
    }
}
expected_toml = """
[a]
b = 1
c = true

[d]
e = [1.2, "foobar"]
""".strip()

def test_to_toml():
    actual = pytomlrs.to_toml(python_value)
    assert actual.strip() == expected_toml

def test_from_toml():
    actual = pytomlrs.from_toml(expected_toml)
    assert actual == python_value
```

ã“ã‚Œã‚’`pytest`ã§æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã€‚

```console
$ poetry run pytest ./tests
============================================= test session starts =============================================
platform darwin -- Python 3.10.7, pytest-7.4.0, pluggy-1.2.0
rootdir: /Users/yyu/Desktop/pytomlrs
collected 2 items

tests/test_pytomlrs.py ..                                                                               [100%]

============================================== 2 passed in 0.23s ==============================================
```

## Wheelä½œæˆ

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Wheelã‚’ä½œæˆã§ãã‚‹ã€‚

```console
$ poetry run maturin build --release 
```

GitHub Actionsã¨é€£æºã™ã‚‹å ´åˆã¯[`PyO3/maturin-action`](https://github.com/PyO3/maturin-action)ãŒä¾¿åˆ©ã§ã‚ã‚‹ã€‚

# ã¾ã¨ã‚

ã“ã®ã‚ˆã†ã«Rustã®å®Ÿè£…ã‚’Pythonã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã€ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã—Wheelã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã€‚