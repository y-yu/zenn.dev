---
title: "LaTeX + TikZでキーボードを描画する"
emoji: "⌨️"
type: "tech"
topics: [latex,tikz,keyboard]
published: true
---

# はじめに

$\LaTeX$でキーボードを描画するという場合、筆者はにせねこさんの[LaTeX (TikZ)でキーボード配列表を作成](https://nixeneko.hatenablog.com/entry/2017/01/06/202312)を利用している。これはとてもよくできたマクロとなっているが、一部のキーを強調表示したくなったり、キーボードの一部だけを表示したくなった場合に不便となっていた。そこでにせねこさんのマクロを少し改造することで、下記のように色を付けたりできるようにした。

![](https://storage.googleapis.com/zenn-user-upload/89c3fcfbbb8d-20251001.png)
_`A`と`M`キーだけ色を変更_

さらに、Shiftキーなどを含む形で一部のキーだけを表示したりもできるようにした。

![](https://storage.googleapis.com/zenn-user-upload/dfd344e253c7-20251001.png)
_キーボードの一部だけを描画_

今回の実装は下記のGitHubリポジトリーで公開している。

- https://github.com/y-yu/tikz-keyboard

# `\keyassign`マクロの改造

元々の実装は`\keyassign`マクロの中で次の2つのマクロを利用するようになっている

1. 普通のキーを描画するための`pics/vhsplit/.style`を利用する`\my@keypath`マクロ
2. Shiftキーなどのキーを描画する`pics/specialkey/.style`を利用する`\my@specialkey`マクロ

そして`\keyassign`のユーザーは（1）の`\my@keypath`の引数を下記のようにCSV形式で入力していく形となる。

```tex
\keyassign{{}{}{\char"07E}{\char"060},{}{}!1,{}{}@2,{}{}\#3,{}{}\$4,{}{}\%5,{}{}{\char"05E}6,{}{}\&7,{}{}*8,{}{}(9,{}{})0,{}{}\_-,{}{}+=}%
{{}{}{}Q,{}{}{}W,{}{}{}E,{}{}{}R,{}{}{}T,{}{}{}Y,{}{}{}U,{}{}{}I,{}{}{}O,{}{}{}P,{}{}\{[,{}{}\}],{}{}|{\char"05C}}%
{{}{}{}A,{}{}{}S,{}{}{}D,{}{}{}F,{}{}{}G,{}{}{}H,{}{}{}J,{}{}{}K,{}{}{}L,{}{}{:}{;},{}{}{\char"022}{\char"027}}%
{{}{}{}Z,{}{}{}X,{}{}{}C,{}{}{}V,{}{}{}B,{}{}{}N,{}{}{}M,{}{}{<}{\char"02C},{}{}{>}.,{}{}?/}
```

`{}{}{}Q`のような表記はそれぞれ`{north-west}{south-west}{north-east}{south-east}`となっており、たとえば`{ou}{っ}{\char"022}{\char"027}`[^char022027]では下記のようなキーが描画される。

![](https://storage.googleapis.com/zenn-user-upload/a1ec91b6d71e-20251001.png =100x)
_`{ou}{っ}{\char"022}{\char"027}`のキー_

[^char022027]: `\char"022`は`"`（ダブルクォーテーション）、`\char"027`は`'`（シングルクォーテーション）をそれぞれ意味する。

元々の`\keyassign`の引数はこのように`vhsplit`スタイルを利用する`\my@keypath`マクロを前提としていたため、Shiftキー周辺の一部のキーだけを表示するというのが難しい状況になっている。そこで次のような改造でユーザーからShiftキーを入力できるようにする。

## `pics/specialkey/.style`の改造

まず`pics/vhsplit/.style`の引数は4つだが`pics/specialkey/.style`は2つとなっており、この2つには互換性がない。よってまずは次のように`pics/specialkey/.style`の（使わない）引数を2つ増やしてまずはこの2つに互換性を与える。

```diff tex
\tikzset{
-  pics/specialkey/.style n args = {2}{
+  pics/specialkey/.style n args = {4}{
    code = {
      \draw[rounded corners=1mm,fill=gray!20] (-3mm,-9.5mm) rectangle (#2-1mm,2.5mm);  
      \node[inner sep=1mm,anchor=south west,text width=#2,align=center] (A) at (-3mm,-9.5mm) {#1};  
    }
  }
}
```

## `\my@keypath`で普通のキーも特殊キーも利用できるようにする

もともと`\my@keypath`は8つの引数だったが、`xparse`パッケージの省略可能引数を駆使して次のように改造した。

1. 新たに省略可能な第3引数を追加してここで`[vhsplit]`や`[specialkey]`でスタイルを指定できるようにした（省略した場合は`vhsplit`になる）
2. 最後の2つの引数が元々は`{vertical-index}{left-offset}`の順序であったが、`left-offset`を省略可能引数にしつつこの2つの順序を入れ替えた

```diff tex
-%{name}{index}{north-west}{south-west}{north-east}{south-east}{vertical-index}{left-offset}
-\def\my@keypath#1#2#3#4#5#6#7#8{%
-  \path pic (#1) at ([xshift=#8\my@keylength]#2\my@keylength,#7\my@keylength) {vhsplit={#3}{#4}{#5}{#6}};
-  \typeout{#1/#2/}
-}
+\def\my@xshift{0}
+%{name}{index}[style]{north-west}{south-west}{north-east}{south-east}[left-offset]{vertical-index}
+\NewDocumentCommand\my@keypath{m m O{vhsplit} m m m m O{\my@xshift} m}{%
+  \typeout{#1/#2/#3/#4/#5/#6/#7/#8/#9}
+  \path pic (#1) at ([xshift=#8]#2\my@keylength,#9\my@keylength) {#3={#4}{#5}{#6}{#7}};
+}
```

これによって元々は`\keyassign`の引数が`{ou}{っ}{\char"022}{\char"027}`のような4つ組であったものが、2つの省略可能引数が拡張されて次のように前後にスタイルと左右オフセットを入力できるようになった。

```tex
\keyassign{}%
{[specialkey]{Ctrl}{15mm}{}{}[0],{}{}{}A,{}{}{}O,{}{}{}E[100]}%
{}%
{}
```

![](https://storage.googleapis.com/zenn-user-upload/3d3a88fcdd30-20251001.png =500x)
_複数スタイルのキーやオフセットを`\keyassign`で表示_

元々の`pics/specialkey/.style`の引数が`pics/vhsplit/.style`と順序含めて互換性がないため、やや分かりにくい状況となっている。とりあえずこのようにすることで`\keyassign`を使って複数種類のキーを入力することができるようになった。
そして、使いやすくするためにCtrlキーのようによく用いられる特殊キーについては次のようにコマンド化しておくことにする。

```tex
\def\BSKey{[specialkey]{Back\\Space}{1.27\my@keylength}{}{}}
\def\TabKey{[specialkey]{Tab}{1.27\my@keylength}{}{}[0]}
\def\CtrlKey{[specialkey]{Ctrl}{1.57\my@keylength}{}{}[0]}
\def\EnterKey{[specialkey]{Enter}{1.47\my@keylength}{}{}}
\def\LeftShiftKey{[specialkey]{Shift}{2.07\my@keylength}{}{}[0]}
\def\RightShiftKey{[specialkey]{Shift}{1.97\my@keylength}{}{}}
```

これによって次のように特殊キーを表示することができる。

```tex
\keyassign{\BSKey}%
{\TabKey}%
{\CtrlKey,\EnterKey}%
{\LeftShiftKey,\RightShiftKey}
```

![](https://storage.googleapis.com/zenn-user-upload/d14a6092ebce-20251001.png =300x)
_簡単化したマクロで特殊キーを`\keyassign`で表示_

## `\@for`の中で`\keyassign`の引数を`\edef`で展開

上述のように`\keyassign`の中で`\CtrlKey`のようなマクロを利用した場合に備えて、元々の実装に加えてイテレーターを`\edef`で展開するコードを次のように追加した。

```diff tex
\@for\lp@elem:=#1\do{%
+ \edef\lp@temp{\lp@elem}%
  \expandafter\def\expandafter\my@cnum\expandafter{\the\my@keycount} %
  \expandafter\def\expandafter\my@keyname\expandafter{\expandafter{\expandafter a\my@cnum}} %
  \expandafter\def\expandafter\my@keyindex\expandafter{\expandafter{\my@cnum}} %
  \expandafter\expandafter\expandafter\expandafter\expandafter\expandafter\expandafter\my@keypath%
- \expandafter\expandafter\expandafter\my@keyname\expandafter\my@keyindex\lp@elem{0}
+ \expandafter\expandafter\expandafter\my@keyname\expandafter\my@keyindex\lp@temp{0} %
  \advance\my@keycount by 1 %
}
```

## 別のスタイル`emphkey`を追加

また、たとえば他にも次のように別のスタイル`emphkey`を定義することによって、特定のキーに色をつけることもできる。

```tex
\tikzset{
  pics/emphkey/.style n args = {4}{
    code = {
      \draw[rounded corners=1mm,fill=yellow!10] (-3mm,-9.5mm) rectangle (9mm,2.5mm);
      \node[anchor=west] (A) at (-3mm,-0.5mm) {#1};
      \node[anchor=west] (B) at (-3mm,-6.5mm) {#2};
      \node[anchor=east] (C) at (9mm,-0.5mm) {#3};
      \node[anchor=east] (D) at (9mm,-6.5mm) {#4};
    }
  }
}
```

```tex
\keyassign{}%
{[emphkey]{}{}{}A,{}{}{}O,{}{}{}E}%
{}%
{}
```

![](https://storage.googleapis.com/zenn-user-upload/177396ede170-20251001.png =300x)
_`A`キーに`emphkey`を指定して色を変えて表示_

# まとめ

やや雑なところもあるが、このように少しの改造で`\keyassign`マクロの表現力をさらに高めることができたと思う。一方で$\TeX$の`\def`マクロで定義されたマクロと、`xparse`パッケージの`\NewDocumentCommand`マクロで定義されたマクロが混在してしまった。この部分はいずれなんとかしたいと考えている。