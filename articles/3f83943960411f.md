---
title: "Windows + MinGW + MSYS2ã§Rustå®Ÿè£…ã®Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’ä½œã‚‹"
emoji: "ğŸªŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "python", "windows", "mingw", "githubactions"]
published: true
---

# ã¯ã˜ã‚ã«

Rustã§Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’ä½œæˆã™ã‚‹æ‰‹æ®µã¨ã—ã¦[PyO3](https://github.com/PyO3/pyo3)ãŒã‚ã‚Šã€éå»ã®è¨˜äº‹ã€Œ[PyO3 + Poetryã§Pythonã‹ã‚‰Rustå®Ÿè£…ã‚’ä½¿ã†](https://zenn.dev/yyu/articles/3b87c9499fddde)ã€ã§ã‚„ã‚Šæ–¹ã‚’è§£èª¬ã—ãŸãŒã€æš—é»™çš„ã«Linuxã‚„macOSã‚’å¯¾è±¡ã¨ã—ã¦ã„ãŸã€‚
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã«ã‚ˆã£ã¦ã¯Windowså‘ã‘ã®Wheelé…å¸ƒãŒå¿…è¦ãªã“ã¨ã‚‚ã‚ã‚‹ãŸã‚ã€ã“ã®è¨˜äº‹ã§ã¯GitHub Actionsã‚’ä½¿ã£ã¦Windows + MinGW + MSYS2ç’°å¢ƒã§PyO3ã¨Rustã‚’ä½¿ã£ãŸPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ãƒ“ãƒ«ãƒ‰æ–¹æ³•ã«ã¤ã„ã¦è¿°ã¹ã‚‹ã€‚
ã“ã®è¨˜äº‹ã§åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®GitHubãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã§ã¾ã¨ã‚ã¦å…¬é–‹ã—ã¦ã„ã‚‹ã€‚

- https://github.com/y-yu/poetry-maturin-mingw-msys2

:::message
ç­†è€…ã¯æ™®æ®µã€å…¨ãWindowsã‚’ä½¿ã£ã¦ã„ãªã„ãŸã‚MSYS2ã‚„MinGWã®èª¬æ˜ã«èª¤ã‚ŠãŒã‚ã‚‹å¯èƒ½æ€§ã«æ³¨æ„ã—ã¦ã»ã—ã„ğŸ™
:::


# GitHub Actionsã®è¨­å®š

ã•ã£ããGitHub Actionsã®è¨­å®šã‚’è§£èª¬ã™ã‚‹ã€‚ãŸã ã—æ¬¡ã®ã‚ˆã†ãª`matrix`ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚

|   åå‰       | æ„å‘³ 	|
|--------------|------	|
| `msystem` 	 | MSYS2ã®ã‚·ã‚¹ãƒ†ãƒ ã§`MINGW64`ãªã©[^environment]|
| `arch`     	 | MSYS2ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ä¾å­˜ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ã§`x86_64`ã‚„`aarch64`ãªã© |
| `path`       | MinGWãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã§`mingw64`ãªã© |
| `rust_target`| Rustã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§`x86_64-pc-windows-gnu`ã‚„`x86_64-pc-windows-msvc`|

[^environment]: https://www.msys2.org/docs/environments/

ãªãŠæœ€çµ‚çš„ãªGitHub Actionsã®è¨­å®šã¯ä¸‹è¨˜ã«ã‚ã‚‹ã€‚

- https://github.com/y-yu/poetry-maturin-mingw-msys2/blob/master/.github/workflows/test.yml

## 1. MSYS2ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`msys2/setup-msys2`ã‚’ä½¿ã†ã“ã¨ã§ç°¡å˜ã«GitHub Actionsã®Windowsã«MSYS2ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã€‚ä»Šå›ã¯æœ€çµ‚çš„ã«Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’ä½œã‚‹ã®ãŒç›®çš„ãªãŸã‚ã€Pythoné–¢é€£ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚ãŸã ã—Rustã¯ã“ã®ã‚ã¨ã®æ‰‹é †ã§å…¬å¼ã®Rustupã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªãã¦ã‚‚ã‚ˆã„ã€‚

```yaml
- name: Install msys2 and dependencies
  uses: msys2/setup-msys2@v2
  with:
    update: true
    path-type: inherit
    msystem: ${{ matrix.msystem }}
    install: >-
      mingw-w64-${{ matrix.arch }}-toolchain
      mingw-w64-${{ matrix.arch }}-python
      mingw-w64-${{ matrix.arch }}-cython
      mingw-w64-${{ matrix.arch }}-python-pip
      mingw-w64-${{ matrix.arch }}-python-poetry
      mingw-w64-${{ matrix.arch }}-python-maturin
```

æ³¨æ„ã¨ã—ã¦ã€`path-type: inherit`ã¨ã—ã¦`PATH`ç’°å¢ƒå¤‰æ•°ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚ã¾ãŸ`cython`ã‚„`toolchain`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã‹ãªã„ã¨PyO3ã¾ã‚ã‚Šã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ã“ã‚Œã‚‰ã‚‚å¿…è¦ã¨ãªã‚‹ã€‚
ã¾ãŸä»Šå›ã¯[Poetry](https://python-poetry.org/)ã‚’ä½¿ã†ã®ã§`python-poetry`ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã€‚

## 2. MSYS2ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã«è¨­å®š

GitHub Actionsã¯å®Ÿè¡Œã‚’Windowsï¼ˆ`windows-latest`ï¼‰ã«ã—ãŸå ´åˆã€`pwsh`ï¼ˆPowerShell Coreï¼‰ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åˆ©ç”¨ã•ã‚Œã‚‹ã€‚ä»Šå›ã¯MSYS2ã‚’ä½¿ã£ã¦ã„ããŸã‚ä¸‹è¨˜ã®ã‚ˆã†ãªè¨­å®šã§`msys2`ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹ã€‚

```yaml
jobs:
  test-mingw:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
```

## 3. Rustupã‚’MSYS2ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Rustã‚’Github Actionsã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´åˆã€ãŸã¨ãˆã°[`dtolnay/rust-toolchain`](https://github.com/marketplace/actions/rustup-toolchain-install)ã¨ã„ã£ãŸä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ãŒã‚ã‚‹ã€‚ã—ã‹ã—ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚·ã‚§ãƒ«ã¨ã—ã¦`bash`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹[^use_bash]ãŸã‚ã€MSYS2ç’°å¢ƒã‚’å¾¹é ­å¾¹å°¾ä½¿ã†ã¨ã„ã†æ–¹é‡ã«åã—ã¦ã—ã¾ã†ã€‚ã‚ˆã£ã¦æ¬¡ã®ã‚ˆã†ã«æ‰‹å‹•ã§[win.rustup.rs](https://win.rustup.rs/)ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã®EXEãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ã“ã‚Œã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹[^refer_from_rustup_ci]ã€‚

```yaml
- name: Install Rustup using win.rustup.rs
  run: |
    curl -o rustup-init.exe -sSL https://win.rustup.rs/
    ./rustup-init.exe -y --default-host=${{ matrix.rust_target }} --profile=minimal
    rm rustup-init.exe
```

[^use_bash]: ãŸã¨ãˆã°ã“ã“ã§`bash`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ğŸ‘‰ https://github.com/dtolnay/rust-toolchain/blob/21dc36fb71dd22e3317045c0c31a3f4249868b17/action.yml#L74

[^refer_from_rustup_ci]: ã“ã®`rustup-init.exe`ã‚’ä½¿ã†æ–¹æ³•ã¯[Rustupã®Windowså‘ã‘CI](https://github.com/rust-lang/rustup/blob/efa576d8fbb4b98cf6dc8770afebc9b1e647f00b/.github/workflows/ci.yaml#L99-L105)ã‚’å‚è€ƒã«ã—ãŸã€‚

ã“ã®ã¨ã`rustup-init.exe`ãŒ`PATH`ã®è¨­å®šã‚’ã™ã‚‹ã®ã§ã€æœ€åˆã§è¡Œã£ãŸMSYS2ã®è¨­å®š`path-type: inherit`ãŒå¿…è¦ã¨ãªã‚‹ã€‚ã‚ã¨ã¯Linuxãªã©ã¨åŒã˜ãæ¬¡ã®ã‚ˆã†ãªæ‰‹é †ã§Rustã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°ã‚ˆã„ã€‚

```yaml
- name: Install Rust
  run: |
    rustup install stable --profile minimal
    rustup default stable
    rustup target add ${{ matrix.rust_target }}
```

## 4. `poetry install`ã‚’å®Ÿè¡Œ

ä»Šå›ã¯`poetry`ã‚’ä½¿ã†ã®ã§`poetry install`ã‚’è¡Œã†ãŒã€`SETUPTOOLS_USE_DISTUTILS=stdlib`ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‹ã‚‰è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚

```yaml
- name: Install Poetry
  run: |
    export SETUPTOOLS_USE_DISTUTILS=stdlib
    poetry install
```

ã“ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã›ãšã«`poetry install`ã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ã«`msgpack._cmsgpack`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¦ã—ã¾ã†ã€‚

```
copying msgpack/__init__.py -> build/lib.mingw_x86_64-cpython-311/msgpack

running build_ext

building 'msgpack._cmsgpack' extension

error: --plat-name must be one of ('win32', 'win-amd64', 'win-arm32', 'win-arm64')
```

## 5. `libpython`ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’è¨­å®š

å ´åˆã«ã‚ˆã£ã¦ã¯ï¼ˆCè¨€èªã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨ã‹ï¼ŸğŸ¤”ï¼‰`libpython`ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®è¨­å®šã‚’ã—ã¦ãŠã‹ãªã„ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã€‚

```
= note: C:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/12.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lpython3.11: No such file or directory
        collect2.exe: error: ld returned 1 exit status
```

ã‚ˆã£ã¦ã€æ¬¡ã®ã‚ˆã†ãª`libpython`ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯è¨­å®šã‚’ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹[^refer_from_setuptools_rust_ci]ã€‚

```yaml
- name: Create libpython symlink
  run: ln -s /${{ matrix.path }}/lib/libpython3.11.dll.a /${{ matrix.path }}/lib/libpython311.dll.a
```

[^refer_from_setuptools_rust_ci]: ã“ã®è¨­å®šã¯[`setuptools_rust`ã®Windowså‘ã‘ã®CI](https://github.com/PyO3/setuptools-rust/blob/34c5f160a3a282ea568d0d285957edbdd927a9c7/.github/workflows/ci.yml#L358-L360)ã‚’å‚è€ƒã«ã—ãŸã€‚

## 6. PyO3ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ« + Wheelä½œæˆ

ã‚ã¨ã¯éå»è¨˜äº‹[PyO3 + Poetryã§Pythonã‹ã‚‰Rustå®Ÿè£…ã‚’ä½¿ã†](https://zenn.dev/yyu/articles/3b87c9499fddde)ãªã©ã®é€šã‚Š`poetry run maturin build`ãªã©ã§Wheelä½œæˆãªã©ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚

# ã¾ã¨ã‚

ç’°å¢ƒå¤‰æ•°`SETUPTOOLS_USE_DISTUTILS`ã‚’è¨­å®šã—ãŸã‚Š`libpython`ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ãŸã‚Šã¨ã€æ™®æ®µã¯ã‚ã¾ã‚ŠWindowsã‚’ä½¿ã‚ãªã„ç­†è€…ã‹ã‚‰ã™ã‚‹ã¨è¬ãªæ‰‹é †ãŒå¤šã„ã€‚ã‚‚ã—ã‹ã—ãŸã‚‰ã‚‚ã£ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãªæ‰‹é †ãŒã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ã¨ã‚Šã‚ãˆãšç¾çŠ¶ã“ã‚Œã§ä¸Šæ‰‹ãã„ã£ãŸã®ã§è¨˜äº‹ã«ã—ã¦ãŠãã€‚